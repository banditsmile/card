<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<meta http-equiv="Content-Type" content="text/html; charset=gb2312"/>
<link rel="stylesheet" type="text/css" href="{$vd['sc']}css/main.css"/>
<style type="text/css">
td{white-space:normal;overflow:auto;text-overflow:none;}
td p{display:none}
td P.show {
  display: block
}
td strong {
cursor:pointer;
color:#0197c9;
padding:0 3px;
}
</style>
</head>
<body>
<div id="titleDiv">
<div style="float:left"><a href="index.php?a=home"><img src="{$vd['sc']}images/home.png" style="vertical-align:middle" border="0"/></a></div><div style="float:left;padding-top:8px;padding-left:3px;"><a href="index.php?a=home" title="回到后台首页"><font color="#000">桌面</font></a> <span style="font-size:7px;">>></span> <span style="font-size:12px;">一卡通卡密生成</span></div>
<div style="float:right;"><a href="index.php" onFocus="this.blur()" title="查看一卡通相关帮助"><img src="{$vd['sc']}images/help.gif" style="vertical-align:middle" border="0"/></a></div>
</div>
<form id="cform" name="cform" method="post" action="index.php?m=mod_b2b&c=ykt&a=save" onsubmit="return checkform()">
<div id="contentTip" style="display:none;"></div>
<div id="content" class="cwarpper">
<div class="cbodyHead"></div>
<div class="cwarpper1">
<div class="ctitle">一卡通生成</div>
<table border="1" id="ctable1" class="ctable"  bordercolor="#ededed">
  <tr>
    <td class="tablelt">一卡通类型</td>
    <td class="tablert">
      <span<!--if(!UB_YKT){--> style="display:none"<!--}-->><input type="radio" value="100" name="ptype" id="ptype1" class="checkbox"<!--if(UB_YKT){-->onclick="setbindpid(1)" checked<!--}--> />一卡通兑换专用卡</span>
      <span<!--if(UB_YKT&&UB_B2C+UB_B2B==0){--> style="display:none"<!--}-->><input type="radio" value="101" name="ptype" class="checkbox" <!--if(UB_YKT){-->onclick="setbindpid(0)" <!--}--><!--if(!UB_YKT){--> checked<!--}--> />一卡通充值专用卡</span>
    </td>
  </tr>
  <tr>
    <td class="tablelt">一卡通面值</td>
    <td class="tablert">
      <div id="yktprice">
        <input type="text" name="yktprice" id="yktprice1" class="myinput"/> {$vd['lang']['moneyunit']}
      </div>
    </td>
  </tr>
  <tr>
    <td class="tablelt">生成数量</td>
    <td class="tablert"><input type="text" name="yktqty" class="myinput" value="100"/> 张卡</td>
  </tr>
  <tr>
    <td class="tablelt">
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>卡号长度不包括前缀的长度，如果您同一个时间段生成的卡密数量过大，请选择长一点的卡号</p>
      卡号前缀
    </td>
    <td class="tablert"><input type="text" name="prefix" class="myinput" value=""/></td>
  </tr>
  <tr>
    <td class="tablelt">
      卡号长度
    </td>
    <td class="tablert">
      <select name="cardlength">
        <option value="10">10位</option>
        <option value="12">12位</option>
        <option value="14">14位</option>
        <option value="15">15位</option>
        <option value="16">16位</option>
        <option value="18">18位</option>
        <option value="20">20位</option>
      </select><strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>不包括前缀的长度，如果您同一个时间段生成的卡密数量过大，请选择长一点的卡号</p>
    </td>
  </tr>
  <tr>
    <td class="tablelt">密码长度</td>
    <td class="tablert">
      <select name="pwdlength">
        <option value="6">6位</option>
        <option value="8">8位</option>
        <option value="10">10位</option>
        <option value="12">12位</option>
        <option value="14">14位</option>
        <option value="15">15位</option>
        <option value="16">16位</option>
        <option value="18">18位</option>
        <option value="20">20位</option>
      </select>
    </td>
  </tr>
  <tr>
    <td class="tablelt">密码组合方式</td>
    <td class="tablert">
      <select name="pwdtype">
        <option value="0">纯数字</option>
        <option value="1">纯字母</option>
        <option value="2">数字+字母</option>
      </select>
    </td>
  </tr>
  <tr>
    <td class="tablelt">是否写入库</td>
    <td class="tablert">
      <select name="iswrite" onchange="setproduct(this)">
        <option value="0">生成文件不导入数据库</option>
        <option value="1" selected >生成文件并且导入数据库</option>
        <option value="2">生成文件并且导入到已有商品</option>
        <option value="3">不生成文件直接导入数据库</option>
      </select>
    </td>
  </tr>
  <tr id="tr1" style="display:none">
    <td class="tablelt">
      导入到商品
    </td>
    <td class="tablert">
      <select id="topid" style="width:250px;" name="topid">
        <option value="0">请选择目标商品</option>
        {#Option($vd['yktitems'], 0, 'pname', 'pid')}
      </select> 
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>如果您希望这次生成的一卡通导入到这个商品的库存里边，选择即可，这里只列举一卡通类型的已有商品(平台卡)</p>
    </td>
  </tr>
  <tr id="trbindpid" <!--if(!UB_YKT){--> style="display:none"<!--}-->>
    <td class="tablelt">
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>如果您希望这次生成的一卡通只能充值此商品，您可以选择绑定，这里只列举对一卡通平台开放购买的产品</p>
      绑定商品
    </td>
    <td class="tablert">
      <select id="bindpid" style="width:250px;" name="bindpid" onchange="setyktnikename(this)">
        <option value="0">不绑定商品</option>
        {#Option($vd['items'], 0, 'pname', 'pid')}
      </select> 
      <input type="text" id="pnamekey" name="pnamekey" size="10" value="" style="height:15px"/><span style="padding-left:5px;"></span><input type="button" value="搜索" onclick="DispSelectZone()" class="button" style="height:20px"/>
    </td>
  </tr>
  <tr>
    <td class="tablelt">相关操作</td>
    <td class="tablert">
      <input type="radio" value="1" name="selladdr" id="selladdr1" class="checkbox" onclick="setaddr(this)"/> 批发平台出售 <input type="radio" value="0" name="selladdr" class="checkbox" id="selladdr2"   checked  onclick="setaddr(this)"/> 其他地方出售 
    </td>
  </tr>
  <tr id="tr_0_0" <!--if(!UB_YKT){--> style="display:none"<!--}-->>
    <td class="tablelt">
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>如果您的一卡通是按照非面值价格销售出去，或者一卡通代理商前台生效的时候，系统将按照这个价格进行扣款，请务必填写一下零售价，方便系统利润统计。留空的话则等于面值</p>
      零售价
    </td>
    <td class="tablert"><input type="text" name="cprice" id="cprice" class="myinput" value="" style="width:100px"/></td>
  </tr>
  <tr id="tr_1_0" style="display:none">
    <td class="tablelt">
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>假如不指定别名，系统会在生成后默认生成一个 "xxx专用卡" 之类的名称。如果您希望在批发平台您的客户可以购买这个一卡通卡密，建议指定一下别名，比如那个一卡通是充值"QQ黄钻"的，您可以起名"QQ黄钻平台卡"</p>
      一卡通别名
    </td>
    <td class="tablert">
      <input type="text" name="yktnickname" class="myinput" id="yktnickname" style="width:400px"/>
    </td>
  </tr>
  <tr id="tr_1_2" style="display:none">
    <td class="tablelt">
      <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>这类型一卡通的进货价，可以填写您绑定的商品的进货价，留空的话则等于一卡通的面值，这个进货价将是经销商购买这个一卡通的价格依据</p>
      进货价
    </td>
    <td class="tablert">
      <input type="text" name="price" class="myinput" id="price" style="width:100px"/>
    </td>
  </tr>
  <tr id="tr_1_1" style="display:none">
    <td class="tablelt">放置类别</td>
    <td class="tablert">
      <input type="radio" value="1" name="tcatid" class="checkbox" onclick="setcat(this)" checked/> 与绑定商品同类目 <input type="radio" value="0" name="tcatid" class="checkbox" onclick="setcat(this)"/> 自定义类目 
    </td>
  </tr>
  <tr id="tr_1_1_0" style="display:none">
    <td class="tablelt">一级分类</td>
    <td class="tablert">
      <select name="ubzdid1" size="1" onChange="changelocation(this.options[this.selectedIndex].value)" class="wenbenkuang">
        <option select="selected" value="0">请选择一级分类</option>
        {#Option($vd['cat'], $vd['parentid'], 'name', 'id')}
      </select>
      <font color="#FF0000">*</font>
    </td>
  </tr>
  <tr id="tr_1_1_1" style="display:none">
    <td class="tablelt">二级分类</td>
    <td class="tablert">
      <select name="catid" class="wenbenkuang">
            {#Option($vd['subcat'], 0, 'name', 'id')}
      </select>
      <font color="#FF0000">*</font>
    </td>
  </tr>
  <tr id="trbindaid" <!--if(!UB_YKT){--> style="display:none"<!--}-->>
    <td class="tablelt">
    	<strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>代理商可以在生效的时候才扣款, 当别人购买使用这个一卡通，绑定的代理商可以查询对应的充值记录或者获得到相应的返点,如果您绑定了代理商并且是代理商前台付费, 那么只能通过前台生效</p>
    	绑定代理商编号
    </td>
    <td class="tablert">
      <input type="text" name="bindaid" id="bindaid" class="myinput" value="" style="width:100px" style="font-weight:normal;background:#EAEAEA;" disabled /> <input type="checkbox" id="ckcardok" name="ckcardok" value="1" onclick="setcardok(this)" style="vertical-align:middle;" class="checkbox" onFocus="this.blur()"/> 
    </td>
  </tr>
  <tr id="tr_okbyaid"  style="display:none">
    <td class="tablelt">线下付款</td>
    <td class="tablert">
      <input type="checkbox" value="1" name="okbyaid" class="checkbox" id="okbyaid"/> <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>
      不打勾表示, 此类卡密只能由一卡通经销通过前台生效<br/>
      </p>
    </td>
  </tr>
  <tr>
    <td class="tablelt">马上生效</td>
    <td class="tablert">
      <input type="checkbox" value="1" name="cardok" class="checkbox"  checked id="cardok"/> <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>
      一卡通生效后：<br/>
      <!--if(UB_YKT){-->一卡通平台用户才可以用来充值或者兑换点卡卡密<br/><!--}-->
      <!--if(UB_B2B){-->批发平台用户才可以用来给余额充值或者从系统中购买对应的平台卡<br/><!--}-->
      <!--if(UB_B2C){-->零售平台用户才可以用来给余额充值<br/><!--}-->
      </p>
    </td>
  </tr>
  <tr style="display:none">
    <td class="tablelt"><strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>
    	仅对"一卡通兑换专用卡"有效，所有"一卡通充值专用卡"使用后都不能再使用，不论你如何设置
    </p>使用后操作
    </td>
    <td class="tablert">
      <input type="radio" value="0" name="allvalid" class="checkbox" checked/> 不可再使用<strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>卡余额变成0，卡状态变成无效，不可继续使用</p> <input type="radio" value="0" name="allvalid" class="checkbox" /> 可再使用 <strong onmouseover="showhide(this);" onmouseout="showhide(this);">[?]</strong><p>状态为卡有效，卡余额则是消费后剩下的余额，可以继续使用</p>
    </td>
  </tr>
  <tr>
    <td class="tablelt">其他说明</td>
    <td class="tablert">
      <!--if(UB_YKT){--> 如果绑定商品，只有同时写入数据库才会有效,如果绑定了代理商, 建议不要勾选生效<!--}else{-->充值专用卡只能用于前台用户余额充值<!--}-->
    </td>
  </tr>
  <tr>
    <td class="tablelt">后台充值密码</td>
    <td class="tablert"><input type="password" id="mytradepwd" name="mytradepwd" value="" style="width:100px"/></td>
  </tr>
  <tr>
    <td class="tablelt"></td>
    <td class="tablert" style="height:80px">
      <input type="submit" value="确认生成 &gt;&gt;" class="bigbtn"/>
      <input type="reset" value="重 置 &gt;&gt;" class="bigbtn"/>
    </td>
  </tr>
</table>
<input type="hidden" value="{$item['cid']}" name="ubzcid" id="ubzcid"/>
</div>
<div class="cbodyFoot"></div>
</div>
<div id="opcontent" style="display:none">
  <div class="optxt">
    
  </div>
</div>
</form>
<script type="text/javascript">
  var ctablenum = 2;
</script>
<script src="{$vd['sc']}js/content.js" type="text/javascript"></script>
<script type="text/javascript">
  function set(id)
  {
    //获取价格
    var selecthtml = "<select name='yktprice'>" + 
                      "<option value='1'>{$vd['lang']['moneysymbol']}1.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='5'>{$vd['lang']['moneysymbol']}5.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='10'>{$vd['lang']['moneysymbol']}10.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='15'>{$vd['lang']['moneysymbol']}15.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='30'>{$vd['lang']['moneysymbol']}30.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='35'>{$vd['lang']['moneysymbol']}35.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='45'>{$vd['lang']['moneysymbol']}45.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='50'>{$vd['lang']['moneysymbol']}50.00{$vd['lang']['moneyunit']}</option>" + 
                      "<option value='100'>{$vd['lang']['moneysymbol']}100.00{$vd['lang']['moneyunit']}</option>" + 
                    "</select>";
    var inputhtml = "<input type='text' name='yktprice' id='yktprice1' class='myinput'/>"
    
    $("yktprice").innerHTML = id ? selecthtml : inputhtml;
  }
  setTableInput();
  
  function setCustom(obj)
  {
    val = obj.options[obj.selectedIndex].value;
    
    if(val == "0")
    {
      $("customprice")
    }
  }
  
  function setproduct(obj)
  {
    val = obj.options[obj.selectedIndex].value;
    
    $("tr1").style.display = val == "2" ? "" : "none";
  }
  
  function setaddr(obj)
  {
    val = obj.value;
    
    if(val == 1)
    {
      for(i = 0; i < 3; i++)
      {
        $("tr_1_" + i).style.display = "";
      }
      
      for(i = 0; i < 1; i++)
      {
        $("tr_0_" + i).style.display = "none";
      }
      
      setyktnikename($("bindpid"));
    }
    else
    {
      for(i = 0; i < 3; i++)
      {
        $("tr_1_" + i).style.display = "none";
      }
      
      for(i = 0; i < 1; i++)
      {
        $("tr_0_" + i).style.display = "";
      }
      
      $("yktnickname").value = "";
    }
  }
  
  function setcat(obj)
  {
    val = obj.value;
    if(val == 0)
    {
      for(i = 0; i < 2; i++)
      {
        $("tr_1_1_" + i).style.display = "";
      }
    }
    else
    {
      for(i = 0; i < 2; i++)
      {
        $("tr_1_1_" + i).style.display = "none";
      }
    }
  }
  
  var oneCount = 0;
  var subCat = new Array();
  var nodes;
  <!--$i = 0;-->
  <!--foreach($vd['category'] as $cat) {-->
    subCat[{$i}] = new Array("{$cat['name']}","{$cat['id']}","{$cat['parentid']}");
  <!--$i++;}-->
  oneCount = {$i};
  
  function changelocation(locationid)
  {
    var i;
    var locationid;
    
    locationid=locationid;
    document.cform.catid.length = 0;
    
    for (i=0;i < oneCount; i++)
    {
      if (subCat[i][2] == locationid)
      {
        document.cform.catid.options[document.cform.catid.length] = new Option(subCat[i][0], subCat[i][1]);
      }        
    }
    
    if(document.cform.catid.length == 0)
    {
      document.cform.catid.options[document.cform.catid.length] = new Option("请选择二级分类", "0");
    }
  }
  
  function setyktnikename(obj)
  {
  	if($("selladdr1").checked)
  	{
      txt = obj.options[obj.selectedIndex].text;
      if(txt == "不绑定商品")
      {
      	vyktprice = "";
      	if($("yktprice1") && $("yktprice1").value != "")
      	{
      		vyktprice = $("yktprice1").value + "{$vd['lang']['moneyunit']}";
      	}
      	
      	if($("ptype1") && $("ptype1").checked)
      	{
      		txt = "平台卡" + vyktprice;
      	}
        else
      	{
      		txt =  "平台" + vyktprice + "加款卡"
      	}
      	
      	$("yktnickname").value = txt;
      }
      else
    	{
        $("yktnickname").value = txt + "平台卡";
      }
    }
    else
  	{
  		$("yktnickname").value = "";
  	}
  }
  
  function setcardok(obj)
  {
  	alert("一卡通兑换专用卡有效,如果您绑定了代理商,并且没有勾选线下付款的话,系统只允许代理商通过前台生效\n\n后台 -〉常规 -〉系统基本设置 -〉前台相关设置 -〉一卡通相关设置 -〉显示代理一卡通卡密 处\n\n可以控制是否允许代理自行生效的时候显示一卡通密码");
  	state   = obj.checked ? false : true;
    bck     = obj.checked ? "#ffffff" : "#EAEAEA";
    
    $("bindaid").disabled = state;

    $("tr_okbyaid").style.display = obj.checked ? "" : "none";
    
    $("okbyaid").checked = state;
    
    $("bindaid").readOnly   = state;
    
    $("bindaid").style.background = bck;
    
    $("bindaid").value = "";
    
    $("cardok").checked = state;
    $("cardok").disabled = obj.checked ? true : false;
  	if(obj.checked)
  	{
  		$("cardok").checked = false
  	}

  }
  
  function checkform()
  {
  	if( $("ckcardok").checked && $("bindaid").value == "")
  	{
  		alert("您好,您勾选了绑定代理商,请输入代理商的编号");
  		return false;
  	}
    else
  	{
  		return true;
  	}
  }
  
  var pArray = new Array();
  
  pidLength = $("bindpid").length;
  
  for(i = 0; i < pidLength; i++)
  {
    pArray[i] = new Array($("bindpid").options[i].value, $("bindpid").options[i].text);
  }
  
  function DispSelectZone()
  {
    $("bindpid").length = 0;
    var keys = trim($("pnamekey").value);
    
    for(i = 0; i < pidLength; i++)
    {
      if(pArray[i][1].toLowerCase().indexOf(keys)>-1)
      {
        $("bindpid").options[$("bindpid").length] = new Option(pArray[i][1], pArray[i][0]);
      }
    }
    if($("bindpid").length > 0)
    {
      setyktnikename($("bindpid"));
    }
    else
  	{
  		$("bindpid").options[0] = new Option("不绑定商品(没有搜到商品)", "0");
  		$("yktnickname").value = "通用平台卡";
  	}
  }
  
  //------------- 
  //去掉字串左边的空格 
  function lTrim(str) 
  { 
    if (str.charAt(0) == " ") 
    { 
      //如果字串左边第一个字符为空格 
      str = str.slice(1);//将空格从字串中去掉 
      //这一句也可改成 str = str.substring(1, str.length); 
      str = lTrim(str); //递归调用 
    } 
    return str; 
  } 
  
  //去掉字串右边的空格 
  function rTrim(str) 
  { 
    var iLength; 
    
    iLength = str.length; 
    if (str.charAt(iLength - 1) == " ") 
    { 
      //如果字串右边第一个字符为空格 
      str = str.slice(0, iLength - 1);//将空格从字串中去掉 
      //这一句也可改成 str = str.substring(0, iLength - 1); 
      str = rTrim(str); //递归调用 
    } 
    return str; 
  } 
  
  //去掉字串两边的空格 
  function trim(str) 
  { 
    return lTrim(rTrim(str)); 
  } 
  
  function setbindpid(vf)
  {
  	$("trbindpid").style.display = vf == 1 ? "" : "none";
  	$("trbindaid").style.display = vf == 1 ? "" : "none";
  }
</script>
</body>
</html>
